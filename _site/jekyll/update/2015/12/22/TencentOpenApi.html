<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" /> <!--[if lte IE 9]><meta http-equiv="refresh" content="0;url=/ie.html"><![endif]--> <title>TencentOpenApi</title> <meta name="description" content="TencentOpenAPI有多坑就不说了，无奈公司要求必须非第三方SDK做分享，所以还是硬着头皮把文档看完了，总结了一下遇到的坑。要做分享的话当然要先到想要分享到的app下注册appid了，做QQ分享就去腾讯开放平台注册一个，很快的，注册完以后会得到一个APP ID和APP KEY，APP KEY应该会用在第三..."> <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,400italic,600|Droid+Sans+Mono' rel='stylesheet' type='text/css'> <link rel="stylesheet" href="/css/main.css"> <link rel="canonical" href="http://yourdomain.com/jekyll/update/2015/12/22/TencentOpenApi.html"> <link rel="alternate" type="application/rss+xml" title="Esley Lance's Blog" href="http://yourdomain.com/feed.xml" /> <script src="/assets/js/prefixfree.js"></script> </head> <body> <aside id="sidebar"> <div id="sidebar-left"> <a id="sidebar-avatar" href="/"> <img id="sidebar-avatar-img" alt="" src="/assets/img/myself.jpg"/> </a> <div id="sidebar-social"> <a href="/feed.xml" class="sidebar-social-icon feed"></a> <a href="mailto:Mmasquerada@outlook.com" class="sidebar-social-icon email"></a> <!-- --> </div> <ul id="sidebar-tags"> <li class="sidebar-tag active" data-filter="all">All posts</li> <li class="sidebar-tag" data-filter="Jekyll">Jekyll</li> <li class="sidebar-tag" data-filter="Update">Update</li> <li class="sidebar-tag" data-filter="Coding">Coding</li> <li class="sidebar-tag" data-filter="Reading">Reading</li> </ul> </div> <!-- <div id="sidebar-right"> <div id="search-box"> <input id="search-input" type="text" placeholder="Search" /> </div> --> <nav id="toc"> <a class="toc-link" data-tags="Coding" href="/2016/01/06/Swift&&Object-C.html"> Swift && Object-C </a> <a class="toc-link" data-tags="Reading" href="/2015/12/23/test.html"> Mr Six </a> <a class="toc-link" data-tags="Coding" href="/jekyll/update/2015/12/22/TencentOpenApi.html"> TencentOpenApi </a> <a class="toc-link" data-tags="Jekyll Update" href="/jekyll/update/2015/03/09/welcome-to-jekyll.html"> Welcome to Jekyll! </a> </nav> </div> </aside> <main id="main"> <article class="post container"> <div class="post-meta"> <span class="post-meta-span date">2015 December 22</span> <span class="post-meta-span tag">Coding</span> </div> <h1 class="post-title">TencentOpenApi</h1> <!--<strong>TencentOpenAPI</strong>--> <p>TencentOpenAPI有多坑就不说了，无奈公司要求必须非第三方SDK做分享，所以还是硬着头皮把文档看完了，总结了一下遇到的坑。</p> <p>要做分享的话当然要先到想要分享到的app下注册appid了，做QQ分享就去腾讯开放平台注册一个，很快的，注册完以后会得到一个APP ID和APP KEY，APP KEY应该会用在第三方分享sdk上，比如SHARESDK和UmengSDK，TencentOpenApi只需要APP ID就可以了，接下来就是将最新下载的TencentOpenApi包导入项目中了，导入之后先运行一下，提示没有错误再进行下一步。</p> <p>这里就在你要分享的类里导入<strong>TencentOpenApi/TencentOAuth.h和TencentOpenApi/QQApiInterface.h,</strong>然后在viewDidLoad里创建一个outh，</p> <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">TencentOauth</span> <span class="o">*</span><span class="n">outh</span> <span class="o">=</span> <span class="p">[[</span><span class="no">TencentOAuth</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">initWithAppID</span><span class="p">:</span><span class="err">@</span><span class="s2">"appid"</span> <span class="n">andDelegate</span><span class="ss">:delegate</span><span class="p">]</span></code></pre></figure> <p>,再在你要分享的按钮下加入以下代码：&lt;/br&gt;</p> <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">NSString</span> <span class="o">*</span><span class="n">utf8String</span> <span class="o">=</span> <span class="err">@</span><span class="s2">"www.baidu.com"</span><span class="p">;</span>
<span class="no">NSString</span> <span class="o">*</span><span class="n">title</span> <span class="o">=</span> <span class="err">@</span><span class="s2">"white"</span><span class="p">;</span>
<span class="no">NSString</span> <span class="o">*</span><span class="n">description</span> <span class="o">=</span> <span class="err">@</span><span class="s2">"you don't know"</span><span class="p">;</span>
<span class="no">NSString</span> <span class="o">*</span><span class="n">path</span> <span class="o">=</span> <span class="p">[[</span><span class="no">NSBundle</span> <span class="n">mainBundle</span><span class="p">]</span> <span class="n">pathForResource</span><span class="p">:</span><span class="err">@</span><span class="s2">"myself"</span> <span class="n">ofType</span><span class="p">:</span><span class="err">@</span><span class="s2">"jpg"</span><span class="p">];</span>
<span class="no">NSData</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="no">NSData</span> <span class="n">dataWithContentsOfFile</span><span class="ss">:path</span><span class="p">];</span>
<span class="no">QQApiNewsObject</span> <span class="o">*</span><span class="n">obj</span> <span class="o">=</span> <span class="p">[</span><span class="no">QQApiNewsObject</span> <span class="n">objectWithURL</span><span class="p">:[</span><span class="no">NSURL</span> <span class="no">URLWithString</span><span class="ss">:utf8String</span><span class="p">]</span> <span class="n">title</span><span class="ss">:title</span> <span class="n">description</span><span class="ss">:description</span> <span class="n">previewImageData</span><span class="ss">:data</span><span class="p">];</span>
<span class="no">SendMessageToQQReq</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="p">[</span><span class="no">SendMessageToQQReq</span> <span class="n">reqWithContent</span><span class="ss">:obj</span><span class="p">];</span>
<span class="p">[</span><span class="no">QQApiInterface</span> <span class="n">sendReq</span><span class="ss">:req</span><span class="p">];</span></code></pre></figure> <p>这里的obj方法中的imageData可以使用url也可以使用MainBundle中的图片，这个看个人需求。另外分享有5种分享消息类型，多数情况是新闻形式的，即有链接，有图片，有描述，所以这里的消息形式是QQApiNewsObject。这时点击按钮会提示如下错误：</p> <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">Undefined</span> <span class="n">symbols</span> <span class="k">for</span> <span class="n">architecture</span> <span class="ss">x86_64:
</span><span class="s2">"_SCNetworkReachabilityCreateWithAddress"</span><span class="p">,</span> <span class="n">referenced</span> <span class="ss">from:
</span><span class="o">+</span><span class="p">[</span><span class="no">TCOSDKReachability</span> <span class="n">reachabilityWithAddress</span><span class="p">:]</span> <span class="k">in</span> <span class="no">TencentOpenAPI</span><span class="p">(</span><span class="no">TCOSDKReachability</span><span class="p">.</span><span class="nf">o</span><span class="p">)</span>
<span class="s2">"_SCNetworkReachabilityCreateWithName"</span><span class="p">,</span> <span class="n">referenced</span> <span class="ss">from:
</span><span class="o">+</span><span class="p">[</span><span class="no">TCOSDKReachability</span> <span class="n">reachabilityWithHostName</span><span class="p">:]</span> <span class="k">in</span> <span class="no">TencentOpenAPI</span><span class="p">(</span><span class="no">TCOSDKReachability</span><span class="p">.</span><span class="nf">o</span><span class="p">)</span>
<span class="s2">"_SCNetworkReachabilityGetFlags"</span><span class="p">,</span> <span class="n">referenced</span> <span class="ss">from:
</span><span class="o">-</span><span class="p">[</span><span class="no">TCOSDKReachability</span> <span class="n">currentReachabilityStatus</span><span class="p">]</span> <span class="k">in</span> <span class="no">TencentOpenAPI</span><span class="p">(</span><span class="no">TCOSDKReachability</span><span class="p">.</span><span class="nf">o</span><span class="p">)</span>
<span class="o">-</span><span class="p">[</span><span class="no">TCOSDKReachability</span> <span class="n">isReachable</span><span class="p">]</span> <span class="k">in</span> <span class="no">TencentOpenAPI</span><span class="p">(</span><span class="no">TCOSDKReachability</span><span class="p">.</span><span class="nf">o</span><span class="p">)</span>
<span class="o">-</span><span class="p">[</span><span class="no">TCOSDKReachability</span> <span class="n">isConnectionRequired</span><span class="p">]</span> <span class="k">in</span> <span class="no">TencentOpenAPI</span><span class="p">(</span><span class="no">TCOSDKReachability</span><span class="p">.</span><span class="nf">o</span><span class="p">)</span>
<span class="o">-</span><span class="p">[</span><span class="no">TCOSDKReachability</span> <span class="n">isConnectionOnDemand</span><span class="p">]</span> <span class="k">in</span> <span class="no">TencentOpenAPI</span><span class="p">(</span><span class="no">TCOSDKReachability</span><span class="p">.</span><span class="nf">o</span><span class="p">)</span>
<span class="o">-</span><span class="p">[</span><span class="no">TCOSDKReachability</span> <span class="n">isInterventionRequired</span><span class="p">]</span> <span class="k">in</span> <span class="no">TencentOpenAPI</span><span class="p">(</span><span class="no">TCOSDKReachability</span><span class="p">.</span><span class="nf">o</span><span class="p">)</span>
<span class="o">-</span><span class="p">[</span><span class="no">TCOSDKReachability</span> <span class="n">isReachableViaWWAN</span><span class="p">]</span> <span class="k">in</span> <span class="no">TencentOpenAPI</span><span class="p">(</span><span class="no">TCOSDKReachability</span><span class="p">.</span><span class="nf">o</span><span class="p">)</span>
<span class="o">-</span><span class="p">[</span><span class="no">TCOSDKReachability</span> <span class="n">isReachableViaWiFi</span><span class="p">]</span> <span class="k">in</span> <span class="no">TencentOpenAPI</span><span class="p">(</span><span class="no">TCOSDKReachability</span><span class="p">.</span><span class="nf">o</span><span class="p">)</span>
<span class="p">.</span><span class="nf">.</span><span class="o">.</span>
<span class="s2">"_SCNetworkReachabilityScheduleWithRunLoop"</span><span class="p">,</span> <span class="n">referenced</span> <span class="ss">from:
</span><span class="o">-</span><span class="p">[</span><span class="no">TCOSDKReachability</span> <span class="n">startNotifier</span><span class="p">]</span> <span class="k">in</span> <span class="no">TencentOpenAPI</span><span class="p">(</span><span class="no">TCOSDKReachability</span><span class="p">.</span><span class="nf">o</span><span class="p">)</span>
<span class="s2">"_SCNetworkReachabilitySetCallback"</span><span class="p">,</span> <span class="n">referenced</span> <span class="ss">from:
</span><span class="o">-</span><span class="p">[</span><span class="no">TCOSDKReachability</span> <span class="n">startNotifier</span><span class="p">]</span> <span class="k">in</span> <span class="no">TencentOpenAPI</span><span class="p">(</span><span class="no">TCOSDKReachability</span><span class="p">.</span><span class="nf">o</span><span class="p">)</span>
<span class="s2">"_SCNetworkReachabilityUnscheduleFromRunLoop"</span><span class="p">,</span> <span class="n">referenced</span> <span class="ss">from:
</span><span class="o">-</span><span class="p">[</span><span class="no">TCOSDKReachability</span> <span class="n">stopNotifier</span><span class="p">]</span> <span class="k">in</span> <span class="no">TencentOpenAPI</span><span class="p">(</span><span class="no">TCOSDKReachability</span><span class="p">.</span><span class="nf">o</span><span class="p">)</span>
<span class="s2">"___gxx_personality_v0"</span><span class="p">,</span> <span class="n">referenced</span> <span class="ss">from:
</span><span class="o">-</span><span class="p">[</span><span class="no">TXAppidConvert</span> <span class="no">InitWithAppId</span><span class="p">:]</span> <span class="k">in</span> <span class="no">TencentOpenAPI</span><span class="p">(</span><span class="no">AppidConvert</span><span class="p">.</span><span class="nf">o</span><span class="p">)</span>
<span class="no">Dwarf</span> <span class="no">Exception</span> <span class="no">Unwind</span> <span class="no">Info</span> <span class="p">(</span><span class="n">__eh_frame</span><span class="p">)</span> <span class="k">in</span> <span class="no">TencentOpenAPI</span><span class="p">(</span><span class="no">AppidConvert</span><span class="p">.</span><span class="nf">o</span><span class="p">)</span>
<span class="ss">ld: </span><span class="n">symbol</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">not</span> <span class="n">found</span> <span class="k">for</span> <span class="n">architecture</span> <span class="n">x86_64</span>
<span class="ss">clang: error: </span><span class="n">linker</span> <span class="n">command</span> <span class="n">failed</span> <span class="n">with</span> <span class="nb">exit</span> <span class="n">code</span> <span class="mi">1</span> <span class="p">(</span><span class="n">use</span> <span class="o">-</span><span class="n">v</span> <span class="n">to</span> <span class="n">see</span> <span class="n">invocation</span><span class="p">)</span></code></pre></figure> <p>这是因为导入SDK之后，还需要导入相应的依赖库，这里点击根目录，再点击其中的BuildPhases中的Link Binary With Libraries，添加SystemConfiguration.framework,libstdc++.6.0.9.tbd,目前只需要加这两个就够了，如果出现其它的类似错误还需要导入其它的依赖库，这时点击按钮，可以看到控制台输出</p> <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="o">-</span><span class="ss">canOpenURL: </span><span class="n">failed</span> <span class="k">for</span> <span class="no">URL</span><span class="p">:</span> <span class="s2">"mqq://"</span> <span class="o">-</span> <span class="ss">error: </span><span class="s2">"This app is not allowed to query for scheme mqq"</span></code></pre></figure> <p>, 这是因为:近期苹果公司iOS 9系统策略更新，限制了http协议的访问，此外应用需要在“Info.plist”中将要使用的URL Schemes列为白名单，才可正常检查其他应用是否安装。受此影响，当你的应用在iOS 9中需要使用QQApi的相关能力（分享、收藏、支付、登录等）时，需要在“Info.plist”里增加如下代码：</p> <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="o">&lt;</span><span class="n">key</span><span class="o">&gt;</span><span class="no">LSApplicationQueriesSchemes</span><span class="o">&lt;</span><span class="sr">/key&gt;
&lt;array&gt;
&lt;string&gt;mqq&lt;/s</span><span class="n">tring</span><span class="o">&gt;</span></code></pre></figure> <p>这行代码的意思是在Info.plist文件中新加一个字典，名字为LSApplicationQueriesSchemes，然后添加数组，数组的元素就是error中的not allowed to query for scheme后面的内容，比如mqq,mqqapi,weixin等等，如果出现</p> <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">The</span> <span class="n">resource</span> <span class="n">could</span> <span class="n">not</span> <span class="n">be</span> <span class="n">loaded</span> <span class="n">because</span> <span class="n">the</span> <span class="no">App</span> <span class="no">Transport</span> <span class="no">Security</span> <span class="n">policy</span> <span class="n">requires</span> <span class="n">the</span> <span class="n">use</span> <span class="n">of</span> <span class="n">a</span> <span class="n">secure</span> <span class="n">connection</span><span class="o">.</span></code></pre></figure> <p>这样的错误的话，则还要加一个字典，名字为App Transport Security Settings,添加一个bool元素Allow Arbitrary Loads，值设为YES。到了这一步，应该就大功告成了.</p> <p>不过为了处理来自QQ的响应还应该设置一下回调，先在项目根目录里Info中的URL Types添加URL Schemes,QQ分享的形式是Tencent+APP ID，即Tencent123456789，然后在AppDelegate中添加function：</p> <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="o">-</span> <span class="p">(</span><span class="no">BOOL</span><span class="p">)</span><span class="n">application</span><span class="p">:(</span><span class="no">UIApplication</span> <span class="o">*</span><span class="p">)</span><span class="n">application</span> <span class="n">openURL</span><span class="p">:(</span><span class="no">NSURL</span> <span class="o">*</span><span class="p">)</span><span class="n">url</span> <span class="n">sourceApplication</span><span class="p">:(</span><span class="no">NSString</span> <span class="o">*</span><span class="p">)</span><span class="n">sourceApplication</span> <span class="n">annotation</span><span class="p">:(</span><span class="nb">id</span><span class="p">)</span><span class="n">annotation</span><span class="p">{</span>
<span class="k">if</span> <span class="p">([[</span><span class="n">url</span> <span class="n">absoluteString</span><span class="p">]</span> <span class="n">hasPrefix</span><span class="p">:</span><span class="err">@</span><span class="s2">"tencent"</span><span class="p">]){</span>
<span class="k">return</span> <span class="p">[</span><span class="no">QQApiInterface</span> <span class="n">handleOpenURL</span><span class="ss">:url</span> <span class="n">delegate</span><span class="ss">:self</span><span class="p">];</span>
<span class="p">}</span>
<span class="k">return</span> <span class="no">YES</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure> <p>加判断是为了处理不同app分享的回调。然后添加代理方法</p> <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="sr">/**
处理来至QQ的请求
*/</span>
<span class="o">-</span> <span class="p">(</span><span class="n">void</span><span class="p">)</span><span class="n">onReq</span><span class="p">:(</span><span class="no">QQBaseReq</span> <span class="o">*</span><span class="p">)</span><span class="n">req</span><span class="p">{</span>

<span class="p">}</span>

<span class="sr">/**
处理来至QQ的响应
*/</span>
<span class="sr">//</span><span class="o">-</span> <span class="p">(</span><span class="n">void</span><span class="p">)</span><span class="n">onResp</span><span class="p">:(</span><span class="no">QQBaseResp</span> <span class="o">*</span><span class="p">)</span><span class="n">resp</span><span class="p">{</span>
<span class="sr">//</span>    
<span class="sr">//</span><span class="p">}</span>

<span class="sr">/**
处理QQ在线状态的回调
*/</span>
<span class="o">-</span> <span class="p">(</span><span class="n">void</span><span class="p">)</span><span class="n">isOnlineResponse</span><span class="p">:(</span><span class="no">NSDictionary</span> <span class="o">*</span><span class="p">)</span><span class="n">response</span><span class="p">{</span>

<span class="p">}</span></code></pre></figure> <p>至此完结。</p> </article> <!-- <div class="post-share"> <div class="container"> <a href="https://twitter.com/share?url=http://yourdomain.com/jekyll/update/2015/12/22/TencentOpenApi.html&text=TencentOpenApi" target="_blank" class="post-share-icon twitter"></a> <a href="https://www.evernote.com/clip.action?url=http://yourdomain.com/jekyll/update/2015/12/22/TencentOpenApi.html&title=TencentOpenApi" target="_blank" class="post-share-icon evernote"></a> <a href="http://service.weibo.com/share/share.php?url=http://yourdomain.com/jekyll/update/2015/12/22/TencentOpenApi.html&title=TencentOpenApi" target="_blank" class="post-share-icon weibo"></a> </div> </div> --> <div class="footer"> <div class="container"> <!-- <p class="footer-entry">All content is licensed under <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA</a></p> --> <p class="footer-entry">Buit with <a href="http://jekyllrb.com/" target="_blank">Jekyll</a> and <a href="https://github.com/P233/3-Jekyll" target="_blank">3-Jekyll theme</a> • Hosted on <a href="https://pages.github.com/" target="_blank">Github</a></p> </div> </div> </main> <!-- <button id="menu"> <span id="menu-icons"></span> </button> --> <script src="/assets/js/jquery-2.1.3.min.js"></script> <script src="/assets/js/jquery.pjax.js"></script> <script src="/assets/js/nprogress.js"></script> <script src="/assets/js/main.js"></script> </body> </html>
